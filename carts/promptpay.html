<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบตรวจสอบ Slip | API Documentation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.7/axios.min.js"></script>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto p-4">
        <!-- Main Grid Layout -->
        
            <!-- Right Panel - Slip Verification Tool -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-purple-800" id="order">เติมเงิน</h1>
                    <p class="text-gray-600">อัพโหลดรูปภาพ หลักฐานการชำระเงินเพื่อตรวจสอบการโอนเงิน</p>
                    <p class="text-purple-700 font-semibold mt-4">จำนวนเงินที่ต้องโอน: <span id="amountText" class="text-xl"></span> บาท</p>
                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const coins = new URLSearchParams(window.location.search).get('coins');
                        document.getElementById('amountText').textContent = coins ? coins : '-';
                    });
                    </script>
                </div>

                <form id="slipForm" class="space-y-6" onsubmit="return false;">
                    <!-- Amount Input -->
                    <div>
                       <!-- <label for="amount" class="block text-sm font-medium text-gray-700 mb-2">
                            จำนวนเงิน ( ระบุจำนวนเงิน )
                        </label>
                        <input type="number" id="amount" 
                               class="w-4/5 px-5 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                               step="0.5" placeholder="ระบุจำนวนเงิน" min="1">
                        <button class="w-1/6 bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors" id="gen">สร้าง QR Code</button>-->
                        <div class="text-center mb-8 text-3xl font-bold flex justify-center items-center" id="qr"></div>
                    </div>

                    <!-- Image Upload Area -->
                    <div>
                        <input type="file" id="imageInput" accept="image/*" class="hidden">
                        <div onclick="document.getElementById('imageInput').click()" 
                             class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-purple-500 transition-colors">
                            <i class="fas fa-cloud-upload-alt text-4xl text-purple-500 mb-4"></i>
                            <p class="text-gray-600">คลิกเพื่ออัพโหลดรูปภาพ Slip</p>
                            <img id="imagePreview" class="mt-4 mx-auto max-h-48 hidden rounded-lg">
                        </div>
                    </div>

                    <!-- Submit Button -->
                   <!-- <button type="submit" onclick="checkSlip()" id="submitBtn" disabled
                            class="w-full bg-purple-600 text-white py-3 rounded-lg font-medium hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                        ตรวจสอบ Slip
                    </button>-->

                    <!-- Loading Indicator -->
                    <div id="loading" class="hidden text-center">
                        <i class="fas fa-spinner fa-spin text-purple-600 text-2xl"></i>
                        <p class="text-gray-600">กำลังตรวจสอบ...</p>
                    </div>
                </form>

                <!-- Result Container -->
                <div id="resultContainer" class="mt-6 hidden">
                    <div id="status" class="mb-4 p-4 rounded-lg text-center"></div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <pre id="result" class="whitespace-pre-wrap break-words text-sm"></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    //console.log(urlParams);
    const coins = urlParams.get('coins');
    //console.log(coins);
    const orderId = urlParams.get('orderId');
    
    document.getElementById('qr').innerHTML = `<img src="https://promptpay.io/0956790178/${coins}.png" alt="QR Code">`;
    document.getElementById('order').innerHTML = `เลขคำสั่งซื้อ ${orderId}`;

    checkLoginStatus();
});
function checkLoginStatus() {
    const username = sessionStorage.getItem('username');
 const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');    //const token = sessionStorage.getItem('token'); // ถ้ามีการใช้ token
  
    if (username) {
      // ผู้ใช้ล็อกอินแล้ว
      //console.log('ผู้ใช้ล็อกอินแล้ว: ' + username + ', userId: ' + userId);
  
      // ทำอะไรบางอย่าง เช่น แสดงข้อมูลผู้ใช้
      const welcomeMessage = document.getElementById('welcomeMessage');
      if (welcomeMessage) {
        welcomeMessage.textContent = 'ยินดีต้อนรับ, ' + username + '!';
      }
  
      // หรือทำอย่างอื่นที่ต้องการเมื่อผู้ใช้ล็อกอิน
    } else {
      // ผู้ใช้ยังไม่ล็อกอิน
      //console.log('ผู้ใช้ยังไม่ได้ล็อกอิน');
  
      // redirect ไปหน้าล็อกอิน
      window.location.href = '../Login'; // เปลี่ยน /login เป็น path ของหน้าล็อกอินของคุณ
    }
  }
  const urlParams = new URLSearchParams(window.location.search);
const imageInput = document.getElementById('imageInput');
const imagePreview = document.getElementById('imagePreview');
const submitBtn = document.getElementById('submitBtn');
const loading = document.getElementById('loading');
const resultContainer = document.getElementById('resultContainer');
const status = document.getElementById('status');
const resultDiv = document.getElementById('result'); // เปลี่ยนชื่อ result เป็น resultDiv เพื่อความชัดเจน
const qrCanvas = document.createElement('canvas'); // สร้าง canvas ไว้ด้านนอก function เพื่อ reuse
const ctx = qrCanvas.getContext('2d');
let amount = urlParams.get('coins'); //ดึงค่า amount มาเก็บไว้

imageInput.addEventListener('change', (event) => {
    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            qrCanvas.width = img.width;
            qrCanvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);

            if (!code) {
                showError('ไม่พบ QR Code ในรูปภาพ');
                submitBtn.disabled = true; // ปิดปุ่ม submit ถ้าอ่าน QR Code ไม่ได้
                return;
            }

            uploadImage(code);
            //console.log(code.data);
        };
        img.src = e.target.result;
        imagePreview.src = e.target.result; //แสดงภาพที่ imagePreview
        imagePreview.classList.remove('hidden'); //โชว์ภาพ
       // submitBtn.disabled = false; //เปิดปุ่ม submit
        
    };

    reader.readAsDataURL(file);
});


async function uploadImage(code) {
    const urlParams = new URLSearchParams(window.location.search);
    let orderId = urlParams.get('orderId');
    amount = urlParams.get('coins'); //ดึงค่า amount มา update
    const data = {
        qrcode_data: code.data
    };
    //console.log('data:', data, 'amount:', amount);

    loading.classList.remove('hidden'); // แสดง loading
  //  submitBtn.disabled = true; // ปิดปุ่ม submit ระหว่าง upload
    resultContainer.classList.add('hidden'); // ซ่อนผลลัพธ์เดิม

    try {
        const response = await fetch(`https://api.openslipverify.com/`, {
            method: 'POST',
            headers: {
          'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "refNbr": data.qrcode_data,
                "amount": amount,
                "token": "185d80d7-106e-4292-9346-4af4cbd10ac1"
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
     const userId = sessionStorage.getItem('userId') || localStorage.getItem('userId');        
        //console.log('data :', result);
        const recheck = result.data;
        if((recheck.receivingBank === "004" && recheck.receiver.name ==="Mr. Weerapon Korong" && (recheck.ref1 === "09xxxx0178")) || (recheck.receivingBank === "004" && recheck.receiver.name ==="Mr. Weerapon Korong" &&  (recheck.receiver.account.value === "XXX-X-XX719-2" || recheck.receiver.account.value === "09xxxx0178" || recheck.receiver.account.value === "XXX-X-XX719-2"))){
            showSuccess('ตรวจสอบสำเร็จ');
            await saveToDatabase(result.data.transRef, result.data.amount, document.getElementById('imageInput').files[0], userId, orderId);
        }else{
            showError('สลิปไม่ถูกต้อง');
        }
            
        
        

    } catch (error) {
        showError(error.message || 'เกิดข้อผิดพลาดในการเรียกใช้ API');
        resultDiv.textContent = error.message; // แสดง error message ใน resultDiv
    } finally {
        loading.classList.add('hidden'); // ซ่อน loading
       // submitBtn.disabled = false; // เปิดปุ่ม submit
        resultContainer.classList.remove('hidden'); // แสดงผลลัพธ์
    }
}

async function saveToDatabase(ref, amount, imageFile, userId, orderId) {
    const formData = new FormData();
    formData.append('ref', ref);
    formData.append('amount', amount);
    formData.append('image', imageFile);
    formData.append('userId', userId);
    formData.append('orderId', orderId);
    
    try {
        const response = await fetch('https://lestialv.ddns.net:3001/slippropay', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (!response.ok) throw new Error(result.error || 'บันทึกข้อมูลล้มเหลว');
        
        showSuccess('บันทึกข้อมูลสำเร็จ');
        setTimeout(() => {
            window.location.href = '../shop';
        }, 5000); // เปลี่ยนเส้นทางไปยัง ../shop หลังจาก 3 วินาที
    } catch (error) {
        showError(error.message);
    }
}

function showError(message) {
    status.className = 'mb-4 p-4 rounded-lg text-center bg-red-100 text-red-700';
    status.textContent = message;
    resultContainer.classList.remove('hidden');
}

function showSuccess(message) {
    status.className = 'mb-4 p-4 rounded-lg text-center bg-green-100 text-green-700';
    status.textContent = message;
    resultContainer.classList.remove('hidden');
}
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"913ceffbbddc604d","version":"2025.1.0","r":1,"token":"4da47c0df4c240e2b26da2872c89cae7","serverTiming":{"name":{"cfExtPri":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}}}' crossorigin="anonymous"></script>
</body>
</html>